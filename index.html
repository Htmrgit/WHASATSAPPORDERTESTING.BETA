/**
 * @file Google Apps Script to serve restaurant menu data from a Google Sheet.
 * @summary This script reads data from a Google Sheet and exposes it as a web API.
 * It is designed to be deployed as a Web App to allow your HTML/JS
 * application to fetch dynamic menu items.
 */

// --- Configuration ---
// IMPORTANT: Replace 'YOUR_SPREADSHEET_ID_HERE' with your actual Google Sheet ID.
// You can find the Spreadsheet ID in the Google Sheet URL:
// https://docs.google.com/spreadsheets/d/YOUR_SPREADSHEET_ID_HERE/edit
const SPREADSHEET_ID ='1XHRdmT7YtFOfnerDIZwdRNI6KiBKWkM7mx0sVe-b6ac'; // <<< REPLACE THIS WITH YOUR SPREADSHEET ID

// Sheet names for menu items and potentially categories (if separate)
const MENU_SHEET_NAME = 'Menu'; // Assumes your main menu items are on a sheet named 'Menu'

/**
 * Handles GET requests to the web app URL.
 * When your web app makes a GET request, this function will execute.
 * It reads data from the Google Sheet and returns it as a JSON string.
 * @returns {GoogleAppsScript.Content.TextOutput} A JSON string of menu items.
 */
function doGet(e) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const menuSheet = spreadsheet.getSheetByName(MENU_SHEET_NAME);

    if (!menuSheet) {
      // If menu sheet is not found, return an error.
      return ContentService.createTextOutput(JSON.stringify({ error: `Sheet '${MENU_SHEET_NAME}' not found.` }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // Get all data from the sheet, assuming the first row is headers.
    // Adjust range if your data doesn't start at A1.
    const dataRange = menuSheet.getDataRange();
    const values = dataRange.getDisplayValues(); // Get values as displayed (formatted)

    if (values.length < 2) {
      // If only headers or no data (only header row), return empty array.
      return ContentService.createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // Assume the first row contains headers like:
    // id, name, description, category, price, image, variants (comma-separated, e.g., Small:9.99,Medium:12.99)
    const headers = values[0];
    const menuItems = [];

    // Process each row (starting from the second row for data)
    for (let i = 1; i < values.length; i++) {
      const row = values[i];
      const item = {};
      let isValidRow = false; // Flag to check if the row has meaningful data

      headers.forEach((header, index) => {
        const key = header.trim().toLowerCase(); // Normalize header for object keys
        let value = row[index];

        if (key === 'id') {
          // Attempt to parse ID, mark row as valid if ID is a number
          const parsedId = parseInt(value);
          if (!isNaN(parsedId)) {
            item[key] = parsedId;
            isValidRow = true;
          } else {
            item[key] = null; // Or handle as desired
          }
        } else if (key === 'price') {
          const parsedPrice = parseFloat(value);
          item[key] = !isNaN(parsedPrice) ? parsedPrice : null;
        } else if (key === 'variants' && value) {
          // Parse variants string: "Small:9.99,Medium:12.99" -> [{name: 'Small', price: 9.99}, ...]
          const variantsArray = value.split(',').map(v => {
            const parts = v.split(':');
            if (parts.length === 2) {
                const variantName = parts[0].trim();
                const variantPrice = parseFloat(parts[1]);
                if (variantName && !isNaN(variantPrice)) {
                    return { name: variantName, price: variantPrice };
                }
            }
            return null; // Return null for invalid variant parts
          }).filter(v => v !== null); // Filter out any invalid variant entries
          
          if (variantsArray.length > 0) {
            item.variants = variantsArray;
            delete item.price; // If variants exist, the direct 'price' field is secondary
          }
        } else {
          item[key] = value;
        }
      });

      // Only push item if it has a valid ID, indicating a non-empty, valid data row.
      if (isValidRow && item.id !== null) {
        menuItems.push(item);
      }
    }

    // Return the menu items as JSON
    return ContentService.createTextOutput(JSON.stringify(menuItems))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // Log the error for debugging in Apps Script dashboard
    Logger.log('Error in doGet: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({ error: error.toString(), message: "Server error occurred while fetching data." }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
